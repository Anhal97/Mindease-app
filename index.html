<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindEase - Your Mental Wellness Companion (India)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .nav-item.active {
            background-color: #3b82f6;
            color: white;
        }
        .main-content > div {
            display: none;
        }
        .main-content > div.active {
            display: block;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        .chat-bubble-user {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble-ai {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .goal-progress {
            transition: width 0.3s ease-in-out;
        }
        #chat-input:disabled {
            background-color: #e5e7eb;
            cursor: not-allowed;
        }
        
        #breathing-circle {
            transition: transform 3s ease-in-out;
        }
        
        @keyframes smooth-breathe {
            0%   { transform: scale(1.0); opacity: 0.8; }
            50%  { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1.0); opacity: 0.8; }
        }
        
        .breathing-animation {
            animation: smooth-breathe 8s ease-in-out infinite;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app-container" class="max-w-4xl mx-auto min-h-screen bg-white shadow-lg flex flex-col md:flex-row">

        <!-- Sidebar Navigation -->
        <aside class="w-full md:w-1/5 bg-blue-500 text-white p-4 flex flex-row md:flex-col justify-around md:justify-start">
            <h1 class="text-2xl font-bold mb-0 md:mb-8 text-center md:text-left">MindEase</h1>
            <nav class="flex flex-row md:flex-col gap-2">
                <button data-target="home" class="nav-item w-full text-left p-3 rounded-lg font-medium transition duration-200 hover:bg-blue-600 active">Home</button>
                <button data-target="journal" class="nav-item w-full text-left p-3 rounded-lg font-medium transition duration-200 hover:bg-blue-600">Journal</button>
                <button data-target="meditate" class="nav-item w-full text-left p-3 rounded-lg font-medium transition duration-200 hover:bg-blue-600">Meditate</button>
                <button data-target="chat" class="nav-item w-full text-left p-3 rounded-lg font-medium transition duration-200 hover:bg-blue-600">Chatbot</button>
                <button data-target="goals" class="nav-item w-full text-left p-3 rounded-lg font-medium transition duration-200 hover:bg-blue-600">Goals</button>
                <button data-target="resources" class="nav-item w-full text-left p-3 rounded-lg font-medium transition duration-200 hover:bg-blue-600">Resources</button>
                <button data-target="settings" class="nav-item w-full text-left p-3 rounded-lg font-medium transition duration-200 hover:bg-blue-600">Settings</button>
            </nav>
            <div id="auth-status" class="mt-auto text-center text-xs p-2">
                Connecting...
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-8 bg-gray-50 overflow-y-auto">
            <div class="main-content">

                <!-- Home Section -->
                <div id="home" class="active animate-fade-in">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Welcome to MindEase</h2>
                    <p class="text-lg text-gray-600 mb-6">Your personal space for mental clarity and peace. Select a tool from the menu to begin your journey towards a healthier mind.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-100 border border-blue-200 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-2 text-blue-800">Reflect on Your Day</h3>
                            <p class="text-blue-700">Use the journal to write down your thoughts and track your mood. Understanding your feelings is the first step to managing them.</p>
                        </div>
                        <div class="bg-green-100 border border-green-200 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-2 text-green-800">Find Your Calm</h3>
                            <p class="text-green-700">Explore guided meditations and breathing exercises to reduce stress and find your center.</p>
                        </div>
                        <div class="bg-purple-100 border border-purple-200 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-2 text-purple-800">AI Companion</h3>
                            <p class="text-purple-700">Talk to our friendly AI chatbot for supportive conversations and coping strategies, anytime you need.</p>
                        </div>
                        <div class="bg-yellow-100 border border-yellow-200 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-2 text-yellow-800">Set Wellness Goals</h3>
                            <p class="text-yellow-700">Create and track small, achievable goals to build positive mental health habits over time.</p>
                        </div>
                    </div>
                </div>

                <!-- Journal Section -->
                <div id="journal">
                    <h2 class="text-3xl font-bold mb-6">My Journal</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-semibold mb-4">How are you feeling today?</h3>
                        <div class="flex items-center space-x-4 mb-4">
                            <label for="mood-select">Mood:</label>
                            <select id="mood-select" class="p-2 border rounded-md">
                                <option>üòä Happy</option>
                                <option>üôÇ Content</option>
                                <option>üòê Neutral</option>
                                <option>üòî Sad</option>
                                <option>üò† Angry</option>
                                <option>üò∞ Anxious</option>
                            </select>
                        </div>
                        <textarea id="journal-entry" class="w-full p-3 border rounded-md" rows="5" placeholder="Write about your day..."></textarea>
                        <button id="save-journal-entry" class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 transition">Save Entry</button>
                    </div>
                    <div id="journal-history">
                        <h3 class="text-2xl font-bold mb-4">Past Entries</h3>
                        <div id="journal-list" class="space-y-4">
                            <p class="text-gray-500">Connecting to database...</p>
                        </div>
                    </div>
                </div>

                <!-- Meditate Section -->
                <div id="meditate">
                    <h2 class="text-3xl font-bold mb-6">Guided Meditation & Breathing</h2>
                    <div id="meditation-player" class="hidden bg-white p-6 rounded-lg shadow-md mb-6 text-center">
                        <h3 id="player-title" class="text-2xl font-semibold mb-4"></h3>
                        <p id="player-description" class="text-gray-600 mb-4"></p>
                        <p id="meditation-timer" class="text-3xl font-mono mb-4 text-gray-700"></p>
                        <div id="breathing-circle" class="w-40 h-40 bg-blue-300 rounded-full mx-auto my-4 flex items-center justify-center">
                            <span id="breathing-text" class="text-xl font-medium text-white"></span>
                        </div>
                        <button id="stop-meditation" class="mt-4 bg-red-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-600 transition">Stop</button>
                    </div>
                    <div id="meditation-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    </div>
                </div>

                <!-- Chatbot Section -->
                <div id="chat" class="flex flex-col h-[calc(100vh-120px)]">
                    <h2 class="text-3xl font-bold mb-4">AI Wellness Companion</h2>
                    <div id="chat-window" class="flex-1 bg-gray-100 p-4 rounded-lg overflow-y-auto mb-4 flex flex-col gap-4">
                    </div>
                    <div id="chat-input-container" class="flex">
                        <input type="text" id="chat-input" class="flex-1 p-3 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your message...">
                        <button id="chat-send" class="bg-blue-500 text-white px-6 py-2 rounded-r-lg font-semibold hover:bg-blue-600 transition">Send</button>
                    </div>
                </div>

                <!-- Goals Section -->
                <div id="goals">
                    <h2 class="text-3xl font-bold mb-6">My Wellness Goals</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-semibold mb-4">Add a New Goal</h3>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="goal-input" class="flex-1 p-3 border rounded-lg" placeholder="e.g., Meditate for 5 minutes">
                            <input type="number" id="goal-target" class="p-3 border rounded-lg w-full sm:w-32" placeholder="Target (days)">
                            <button id="add-goal" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 transition">Add Goal</button>
                        </div>
                    </div>
                    <div id="goal-list" class="space-y-4">
                        <p class="text-gray-500">Connecting to database...</p>
                    </div>
                </div>

                <!-- Resources Section (UPDATED FOR INDIA) -->
                <div id="resources">
                    <h2 class="text-3xl font-bold mb-6">Support & Resources (India)</h2>
                    <div class="space-y-6">
                        
                        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-500">
                            <h3 class="text-xl font-semibold mb-2">Immediate Support Helplines (24/7)</h3>
                            <p class="text-gray-600 mb-4">If you are in crisis or need immediate support, please reach out. These services are free and confidential.</p>
                            <div class="space-y-2">
                                <p><strong>KIRAN (Govt. of India):</strong> <a href="tel:1800-599-0019" class="text-red-600 font-semibold hover:underline">1800-599-0019</a></p>
                                <p><strong>Vandrevala Foundation:</strong> <a href="tel:+919999666555" class="text-red-600 font-semibold hover:underline">+91 9999 666 555</a></p>
                                <p><strong>AASRA (Suicide Prevention):</strong> <a href="tel:+919820466726" class="text-red-600 font-semibold hover:underline">+91 98204 66726</a></p>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-2">NIMHANS (National Institute)</h3>
                            <p class="text-gray-600 mb-4">Access patient care information, resources, and publications from India's leading mental health institution (NIMHANS).</p>
                            <a href="https://nimhans.ac.in/patient-care/" target="_blank" class="text-blue-500 font-semibold hover:underline">Explore NIMHANS Resources &rarr;</a>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-2">Find a Therapist in India</h3>
                            <p class="text-gray-600 mb-4">Finding a professional to talk to is a sign of strength. Use this resource to find verified mental health professionals across India.</p>
                            <a href="https://www.themindclan.com/find-support" target="_blank" class="text-blue-500 font-semibold hover:underline">Browse The Mind Clan Directory &rarr;</a>
                        </div>

                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings">
                    <h2 class="text-3xl font-bold mb-6">Settings</h2>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-2">About MindEase</h3>
                            <p class="text-gray-600 mb-4">This application is designed to provide you with tools for mental wellness. All your journal entries and goals are saved securely to your personal cloud account.</p>
                            <p id="firebase-status" class="text-sm mt-2 text-gray-500"></p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-2">Data Export</h3>
                            <p class="text-gray-600 mb-4">Download your personal data from the app. The files will be in JSON format.</p>
                            <div class="flex gap-4">
                                <button id="download-journal" class="bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-600 transition">Download Journal</button>
                                <button id="download-goals" class="bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-600 transition">Download Goals</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, setDoc, deleteDoc, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mindease-app';
        let app, auth, db, userId, journalUnsubscribe, goalsUnsubscribe;

        // --- DOM ELEMENTS ---
        const saveJournalBtn = document.getElementById('save-journal-entry');
        const stopMeditationBtn = document.getElementById('stop-meditation');
        const chatSendBtn = document.getElementById('chat-send');
        const chatInput = document.getElementById('chat-input');
        const addGoalBtn = document.getElementById('add-goal');

        // --- INITIALIZATION ---
        async function initializeAppLogic() {
            const authStatus = document.getElementById('auth-status');
            const firebaseStatus = document.getElementById('firebase-status');
            
            // Check if we are on the live Netlify site
            const isLive = window.location.hostname.endsWith('.netlify.app');

            try {
                let userFirebaseConfig;

                if (isLive) {
                    const response = await fetch('/.netlify/functions/get-firebase-config');
                    if (!response.ok) {
                        throw new Error("Could not fetch Firebase config from server.");
                    }
                    userFirebaseConfig = await response.json();
                } else {
                    // Fallback for local/preview environment.
                    console.warn("Running in local/preview mode. Using fallback Firebase config.");
                    authStatus.textContent = "Preview Mode";
                    userFirebaseConfig = {
                        apiKey: "AIzaSyBMbHtGu_AYgGzTwe8RcZsor23LosB2JRU",
                        authDomain: "mindeaseapp-7a724.firebaseapp.com",
                        projectId: "mindeaseapp-7a724"
                    };
                    
                    if (!userFirebaseConfig.apiKey) {
                         throw new Error("Fallback Firebase config is missing. App will not work in preview.");
                    }
                }

                if (!userFirebaseConfig || !userFirebaseConfig.apiKey) {
                    throw new Error("Received invalid Firebase config.");
                }
                
                if (firebaseStatus) {
                    firebaseStatus.textContent = isLive ? "Firebase configuration loaded securely." : "Firebase config (Preview Mode)";
                    firebaseStatus.className = "text-sm mt-2 text-green-600";
                }
                
                await initializeFirebase(userFirebaseConfig);

            } catch (error) {
                console.error("Initialization Error:", error);
                authStatus.textContent = "Connection Failed";
                authStatus.classList.add("text-red-400");
                if (firebaseStatus) {
                    firebaseStatus.textContent = `Error: ${error.message}`;
                    firebaseStatus.className = "text-sm mt-2 text-red-600";
                }
            }
        }

        async function initializeFirebase(firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const authStatus = document.getElementById('auth-status');
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = `Connected`;
                        loadAppData();
                    } else {
                        try {
                             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Anonymous sign-in failed:", error);
                            authStatus.textContent = "Auth Failed";
                        }
                    }
                });
            } catch(e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('auth-status').textContent = "Firebase Init Failed";
            }
        }

        function loadAppData() {
            loadJournalEntries();
            loadGoals();
        }

        // --- NAVIGATION ---
        const navButtons = document.querySelectorAll('.nav-item');
        const contentDivs = document.querySelectorAll('.main-content > div');

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.dataset.target;
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                contentDivs.forEach(div => {
                    div.classList.remove('active');
                    if (div.id === targetId) {
                        div.classList.add('active');
                    }
                });
            });
        });

        // --- JOURNAL LOGIC ---
        const journalEntryInput = document.getElementById('journal-entry');
        const moodSelect = document.getElementById('mood-select');
        const journalList = document.getElementById('journal-list');

        async function saveJournalEntry() {
            if (!userId) {
                console.warn("User not connected, cannot save journal.");
                return;
            }
            const entryText = journalEntryInput.value.trim();
            const mood = moodSelect.value;
            if (entryText === "") return;

            try {
                const journalCollection = collection(db, `artifacts/${appId}/users/${userId}/journal`);
                await addDoc(journalCollection, {
                    mood: mood,
                    text: entryText,
                    createdAt: serverTimestamp()
                });
                journalEntryInput.value = "";
            } catch (error) {
                console.error("Error saving journal entry:", error);
            }
        }

        function loadJournalEntries() {
            if (!userId) return;
            if (journalUnsubscribe) journalUnsubscribe();

            const journalCollection = collection(db, `artifacts/${appId}/users/${userId}/journal`);
            const q = query(journalCollection, orderBy("createdAt", "desc"));
            
            journalUnsubscribe = onSnapshot(q, (snapshot) => {
                journalList.innerHTML = "";
                if (snapshot.empty) {
                    journalList.innerHTML = `<p class="text-gray-500">No journal entries yet.</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const entry = doc.data();
                    const entryEl = document.createElement('div');
                    entryEl.className = 'bg-white p-4 rounded-lg shadow';
                    const date = entry.createdAt ? entry.createdAt.toDate().toLocaleDateString() : 'Just now';
                    entryEl.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <p class="font-semibold text-lg">${entry.mood}</p>
                            <p class="text-sm text-gray-500">${date}</p>
                        </div>
                        <p class="text-gray-700">${entry.text}</p>
                    `;
                    journalList.appendChild(entryEl);
                });
            }, (error) => console.error("Error loading journal:", error));
        }

        // --- MEDITATION LOGIC (REBUILT) ---
        const meditationList = document.getElementById('meditation-list');
        const meditationPlayer = document.getElementById('meditation-player');
        const playerTitle = document.getElementById('player-title');
        const playerDescription = document.getElementById('player-description');
        const breathingCircle = document.getElementById('breathing-circle');
        const breathingText = document.getElementById('breathing-text');
        const meditationTimer = document.getElementById('meditation-timer');
        
        let synth, timerInterval, meditationStepInterval; 

        const sessions = [
            { id: 'box-breathing', title: 'Box Breathing', description: 'A simple technique to calm your nervous system. Inhale (4s), Hold (4s), Exhale (4s), Hold (4s).', duration: 120 },
            { id: 'mindful-breath', title: 'Mindful Breath', description: 'Focus on your natural breath to anchor yourself in the present moment.', duration: 180 },
            { id: '5-minute-calm', title: '5-Minute Calm', description: 'A short session to quickly reset and de-stress.', duration: 300 }
        ];

        function formatTime(seconds) {
            const m = String(Math.floor(seconds / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${m}:${s}`;
        }

        function renderMeditationList() {
            meditationList.innerHTML = '';
            sessions.forEach(session => {
                const sessionEl = document.createElement('div');
                sessionEl.className = 'bg-white p-6 rounded-lg shadow-md cursor-pointer hover:shadow-xl transition';
                sessionEl.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2">${session.title}</h3>
                    <p class="text-gray-600">${session.description}</p>
                    <p class="text-sm text-gray-500 mt-2">${session.duration / 60} minutes</p>
                `;
                sessionEl.addEventListener('click', () => startMeditation(session.id));
                meditationList.appendChild(sessionEl);
            });
        }
        
        function startMeditation(sessionId) {
            stopMeditation(); 

            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            meditationList.classList.add('hidden');
            meditationPlayer.classList.remove('hidden');
            playerTitle.textContent = session.title;
            playerDescription.textContent = session.description;
            
            Tone.start().catch(e => console.error("Tone.js could not start: ", e));
            synth = new Tone.Synth().toDestination();
            
            let duration = session.duration;
            meditationTimer.textContent = formatTime(duration);
            
            timerInterval = setInterval(() => {
                duration--;
                meditationTimer.textContent = formatTime(duration);
                if (duration <= 0) {
                    stopMeditation();
                }
            }, 1000);
            
            breathingCircle.classList.remove('breathing-animation'); 
            
            if (sessionId === 'box-breathing') {
                runBoxBreathing();
            } else {
                breathingCircle.classList.add('breathing-animation');
                breathingText.textContent = 'Breathe';
            }
        }

        function runBoxBreathing() {
            const sequence = ['Inhale', 'Hold', 'Exhale', 'Hold'];
            let step = 0;
            
            const nextStep = () => {
                const instruction = sequence[step % 4];
                breathingText.textContent = instruction;
                if(Tone.context.state === 'running') synth.triggerAttackRelease("C4", "0.1");

                if (instruction === 'Inhale') {
                    breathingCircle.style.transform = 'scale(1.2)';
                } else if (instruction === 'Exhale') {
                    breathingCircle.style.transform = 'scale(1.0)';
                }
                
                step++;
            };
            
            nextStep();
            meditationStepInterval = setInterval(nextStep, 4000);
        }

        function stopMeditation() {
            clearInterval(timerInterval);
            clearInterval(meditationStepInterval);
            timerInterval = null;
            meditationStepInterval = null;
            
            if (synth) synth.dispose();
            
            meditationPlayer.classList.add('hidden');
            meditationList.classList.remove('hidden');
            
            breathingCircle.classList.remove('breathing-animation');
            breathingCircle.style.transform = 'scale(1)';
            breathingText.textContent = '';
            meditationTimer.textContent = ''; 
        }

        // --- CHATBOT LOGIC ---
        const chatWindow = document.getElementById('chat-window');
        
        // UPDATED SYSTEM PROMPT FOR INDIA
        const systemPrompt = "You are a caring and supportive mental wellness assistant named 'Ease'. Your role is to provide a safe, non-judgmental space for users, with a specific focus on India. Offer comfort, practical advice based on CBT and mindfulness, and gentle encouragement. Do not provide medical diagnoses. If a user seems to be in serious distress, gently suggest they seek professional help and provide them with India-specific resources. Key Indian helplines to offer include KIRAN at 1800-599-0019 (a 24/7 national helpline) and the Vandrevala Foundation at +91 9999 666 555. Keep your responses concise, empathetic, and culturally aware for an Indian audience.";
        
        let chatHistory = [];
        
        function updateChatUI() {
            chatInput.disabled = false;
            chatSendBtn.disabled = false;
            chatInput.placeholder = "Type your message...";
            if (chatHistory.length === 0) {
                chatHistory = [{ role: "model", parts: [{ text: "Hello! I'm Ease, your wellness companion. How are you feeling today?" }] }];
            }
            renderChatHistory();
        }

        function renderChatHistory() {
            chatWindow.innerHTML = '';
            chatHistory.forEach(msg => {
                const isUser = msg.role === 'user';
                addMessageToChat(msg.parts[0].text, isUser);
            });
        }
        
        function addMessageToChat(text, isUser) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isUser ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
            bubble.textContent = text;
            chatWindow.appendChild(bubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function getAIResponse(userMessage) {
            addMessageToChat(userMessage, true);
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'chat-bubble chat-bubble-ai animate-pulse';
            loadingBubble.textContent = '...';
            chatWindow.appendChild(loadingBubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            
            const isLive = window.location.hostname.endsWith('.netlify.app');
            const apiUrl = isLive ? '/.netlify/functions/ask-chatbot' : null;

            if (!apiUrl) {
                loadingBubble.remove();
                addMessageToChat("The chatbot feature only works on the live, deployed Netlify website. This preview environment cannot access the secure AI key.", false);
                chatHistory.pop(); // remove the user message
                return;
            }

            try {
                const payload = {
                    contents: chatHistory, // Send the chat history
                    systemInstruction: { parts: [{ text: systemPrompt }] }, // Add the system prompt
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`The server responded with an error.`);
                }

                const result = await response.json();
                const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                loadingBubble.remove();

                if (aiText) {
                    addMessageToChat(aiText, false);
                    chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                } else {
                    // Check for blockage
                    if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                        addMessageToChat("I'm sorry, I can't respond to that topic. Let's talk about something else.", false);
                    } else {
                        addMessageToChat("I'm sorry, I couldn't process that. Please try again.", false);
                    }
                    chatHistory.pop(); // remove the user message if AI fails
                }

            } catch (error) {
                console.error("Error fetching AI response:", error);
                loadingBubble.remove();
                addMessageToChat("There was an error connecting to the chatbot. Please try again later.", false);
                chatHistory.pop(); // remove the user message if AI fails
            }
        }
      
        async function handleChatSend() {
            const message = chatInput.value.trim();
            if (message) { 
                chatInput.value = "";
                await getAIResponse(message);
            }
        }
        
        // --- GOALS LOGIC ---
        const goalInput = document.getElementById('goal-input');
        const goalTargetInput = document.getElementById('goal-target');
        const goalList = document.getElementById('goal-list');

        async function addGoal() {
            if (!userId) {
                console.warn("User not connected, cannot save goal.");
                return;
            }
            const text = goalInput.value.trim();
            const target = parseInt(goalTargetInput.value, 10);
            if (text === "" || isNaN(target) || target <= 0) return;
            
            try {
                const goalsCollection = collection(db, `artifacts/${appId}/users/${userId}/goals`);
                await addDoc(goalsCollection, {
                    text: text,
                    progress: 0,
                    target: target,
                    createdAt: serverTimestamp()
                });
                goalInput.value = "";
                goalTargetInput.value = "";
            } catch(error) {
                console.error("Error adding goal:", error);
            }
        }

        function loadGoals() {
            if (!userId) return;
            if (goalsUnsubscribe) goalsUnsubscribe();

            const goalsCollection = collection(db, `artifacts/${appId}/users/${userId}/goals`);
            const q = query(goalsCollection, orderBy("createdAt", "desc"));

            goalsUnsubscribe = onSnapshot(q, (snapshot) => {
                goalList.innerHTML = "";
                if (snapshot.empty) {
                    goalList.innerHTML = `<p class="text-gray-500">No goals set yet. Add one to get started!</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const goal = doc.data();
                    const goalEl = document.createElement('div');
                    goalEl.className = 'bg-white p-4 rounded-lg shadow';
                    const percentage = goal.target > 0 ? Math.round((goal.progress / goal.target) * 100) : 0;
                    
                    goalEl.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <p class="font-semibold">${goal.text}</p>
                            <p class="text-sm text-gray-600">${goal.progress} / ${goal.target} days</p>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-green-500 h-4 rounded-full goal-progress" style="width: ${percentage}%"></div>
                        </div>
                        <div class="flex justify-end gap-2 mt-3">
                            <button data-id="${doc.id}" data-progress="${goal.progress}" class="increment-btn bg-green-100 text-green-800 px-3 py-1 text-sm rounded-full hover:bg-green-200 transition">+1 Day</button>
                            <button data-id="${doc.id}" class="delete-btn bg-red-100 text-red-800 px-3 py-1 text-sm rounded-full hover:bg-red-200 transition">Delete</button>
                        </div>
                    `;
                    goalList.appendChild(goalEl);
                });

                document.querySelectorAll('.increment-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.target.dataset.id;
                        let progress = parseInt(e.target.dataset.progress, 10);
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/goals`, id);
                        await setDoc(docRef, { progress: progress + 1 }, { merge: true });
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.target.dataset.id;
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/goals`, id);
                        await deleteDoc(docRef);
                    });
                });
            }, (error) => console.error("Error loading goals:", error));
        }

        // --- DATA DOWNLOAD ---
        const downloadJournalBtn = document.getElementById('download-journal');
        const downloadGoalsBtn = document.getElementById('download-goals');
        
        async function downloadCollectionAsJSON(collectionName, fileName) {
            if (!userId) {
                console.warn("User not connected, cannot download data.");
                return;
            }
            try {
                const colRef = collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
                const snapshot = await getDocs(query(colRef, orderBy("createdAt", "desc")));
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const jsonString = JSON.stringify(data, (key, value) => {
                    if (value && typeof value.toDate === 'function') {
                        return value.toDate().toISOString();
                    }
                    return value;
                }, 2);

                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileName}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error(`Error downloading ${collectionName}:`, error);
            }
        }

        // --- EVENT LISTENERS & INITIAL LOAD ---
        window.onload = () => {
            document.getElementById('app-container').style.display = 'flex';
            
            initializeAppLogic(); 
            
            renderMeditationList(); 
            updateChatUI();

            saveJournalBtn.addEventListener('click', saveJournalEntry);
            stopMeditationBtn.addEventListener('click', stopMeditation);
            chatSendBtn.addEventListener('click', handleChatSend);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleChatSend();
            });
            addGoalBtn.addEventListener('click', addGoal);
            
            downloadJournalBtn.addEventListener('click', () => downloadCollectionAsJSON('journal', 'mindease_journal'));
            downloadGoalsBtn.addEventListener('click', () => downloadCollectionAsJSON('goals', 'mindease_goals'));
        };
    </script>
</body>
</html>
